"use strict";var e=require("fs"),r=require("path"),t=require("assert");function n(e){var r=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}}),r.default=e,Object.freeze(r)}var o=n(e),i=n(r);function c(e){return e.replace(/^\w/,function(e){return e.toLowerCase()}).replace(/-\w/g,function(e){var r=e.charAt(1),t=r.toUpperCase();return r===t&&r.match(/\d/)?e:t})}function a(e,r){return r=r||2,("0000"+e).slice(-r)}function u(e,r,t,n,c){var u;try{var l=[n.outfile?i.dirname(n.outfile):null,n.inputPath,process.cwd()],s=i.basename(n.inputFilename||n.moduleName||(n.outfile?i.dirname(n.outfile):null)||n.defaultModuleName||r).replace(/\.[a-z]{1,5}$/i,"").replace(/[^a-z0-9_]/ig,"_");(""===s||"_"===s)&&(s="__bugger__"),t=t||"XXX";var f=new Date,d=f.getUTCFullYear()+"_"+a(f.getUTCMonth()+1)+"_"+a(f.getUTCDate())+"T"+a(f.getUTCHours())+a(f.getUTCMinutes())+a(f.getUTCSeconds())+"."+a(f.getUTCMilliseconds(),3)+"Z";s+=".fatal_"+t+"_dump_"+d+".js";for(var p=0,g=l.length;p<g;p++)if(l[p])try{u=i.normalize(l[p]+"/"+s),o.writeFileSync(u,e,"utf8"),console.error("****** offending generated "+r+" source code dumped into file: ",u);break}catch(e){if(p===g-1)throw e}}catch(e){console.error("generated "+r+" source code fatal DUMPING error: ",e.message," -- while attempting to dump into file: ",u,"\n",e.stack)}c&&(c.offending_source_code=e,c.offending_source_title=r,c.offending_source_dumpfile=u)}var l={exec:function(e,r,t,n){t=t||{};var o,i,c=""+(n||"exec_test"),a=c.replace(/[^a-z0-9_]/ig,"_");0===a.length&&(a="exec_crash");try{if("function"!=typeof r)throw Error("safe-code-exec-and-diag: code_execution_rig MUST be a JavaScript function");o=e,(o=String(o)).match(/\bcov_\w+/)&&console.error("### ISTANBUL COVERAGE CODE DETECTED ###\n",o),i=r.call(this,e,t,c,0)}catch(r){if(t.dumpSourceCodeOnFailure&&u(e,c,a,t,r),t.throwErrorOnCompileFailure)throw r}return i},dump:u};const s=require("@gerhobbelt/recast");t(s);var f=s.types;function d(e){return s.parse(e)}t(f),t(f.namedTypes),t(f.builders);function p(e){var r,t=String(e);return(r=String(r=t)).match(/\bcov_\w+/)&&console.error("### ISTANBUL COVERAGE CODE DETECTED ###\n",r),t}const g=/^function[\s\r\n]*[^\(]*\(([^\)]*)\)[\s\r\n]*\{([^]*?)\}$/,_=/^(?:(?:\(([^\)]*)\))|(?:([^\(\)]+)))[\s\r\n]*=>[\s\r\n]*(?:(?:\{([^]*?)\})|(?:(([^\s\r\n\{)])[^]*?)))$/;var h={rmCommonWS:function(e,...r){var t=null,n=e.map(function(e){var r=e.split("\n");return t=r.reduce(function(e,r,t){if(0!==t){var n=/^(\s*)\S/.exec(r);n&&(e?n[1].length<e.length&&(e=n[1]):e=n[1])}return e},t),r}),o=n[n.length-1];if(o[o.length-1]=o[o.length-1].replace(/\s+$/,""),t)for(var i=0,c=n.length;i<c;i++)for(var a,u,o=n[i],l=1,s=o.length;l<s;l++)a=o[l],u=t,a.substr(0,u.length)===u&&(o[l]=o[l].substr(t.length));for(var f=[],i=0,c=r.length;i<c;i++)f.push(n[i].join("\n")),f.push(r[i]);return f.push(n[i].join("\n")),f.join("")},camelCase:c,mkIdentifier:function(e){return(e=c(""+e)).replace(/^[^\w_]/,"_").replace(/^\d/,"_").replace(/[^\w\d_]+/g,"_").replace(/^__+/,"#").replace(/__+$/,"#").replace(/_+/g,"_").replace(/#/g,"__")},dquote:function(e){var r=e.indexOf("'")>=0,t=e.indexOf('"')>=0;return r&&t&&(e=e.replace(/"/g,'\\"'),t=!1),e=t?"'"+e+"'":'"'+e+'"'},exec:l.exec,dump:l.dump,parseCodeChunkToAST:d,prettyPrintAST:function(e,r){var r=r||{};let t={tabWidth:2,quote:"single",arrowParensAlways:!0,reuseWhitespace:!1};for(var n in t)void 0===r[n]&&(r[n]=t[n]);return s.prettyPrint(e,{tabWidth:2,quote:"single",arrowParensAlways:!0,reuseWhitespace:!1}).code.replace(/\r\n|\n|\r/g,"\n")},checkActionBlock:function(e,r){if(r&&r.first_line>0&&(e=Array(r.first_line).join("\n")+e),!e.trim())return!1;try{return d(e),!1}catch(e){return e.message||"code snippet cannot be parsed"}},printFunctionSourceCode:p,printFunctionSourceCodeContainer:function(e){var r,t=p(e).trim(),n=g.exec(t);if(n)r=n[1].trim(),t=n[2].trim();else if(n=_.exec(t))r=n[2]?n[2].trim():n[1].trim(),t=n[5]?"return "+(t=n[4].trim())+";":n[3].trim();else{var o=Error("Cannot extract code from function");throw o.subject=t,o}return{args:r,code:t}},detectIstanbulGlobal:function(){return Function("return this")().__coverage__||!1}};module.exports=h;
