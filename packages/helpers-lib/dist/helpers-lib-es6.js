import*as e from"fs";import*as r from"path";import t from"assert";function n(e){return e.replace(/^\w/,function(e){return e.toLowerCase()}).replace(/-\w/g,function(e){var r=e.charAt(1),t=r.toUpperCase();return r===t&&r.match(/\d/)?e:t})}function o(e,r){return r=r||2,("0000"+e).slice(-r)}function i(t,n,i,a,c){var u;try{var l=[a.outfile?r.dirname(a.outfile):null,a.inputPath,process.cwd()],s=r.basename(a.inputFilename||a.moduleName||(a.outfile?r.dirname(a.outfile):null)||a.defaultModuleName||n).replace(/\.[a-z]{1,5}$/i,"").replace(/[^a-z0-9_]/ig,"_");(""===s||"_"===s)&&(s="__bugger__"),i=i||"XXX";var f=new Date,d=f.getUTCFullYear()+"_"+o(f.getUTCMonth()+1)+"_"+o(f.getUTCDate())+"T"+o(f.getUTCHours())+o(f.getUTCMinutes())+o(f.getUTCSeconds())+"."+o(f.getUTCMilliseconds(),3)+"Z";s+=".fatal_"+i+"_dump_"+d+".js";for(var p=0,g=l.length;p<g;p++)if(l[p])try{u=r.normalize(l[p]+"/"+s),e.writeFileSync(u,t,"utf8"),console.error("****** offending generated "+n+" source code dumped into file: ",u);break}catch(e){if(p===g-1)throw e}}catch(e){console.error("generated "+n+" source code fatal DUMPING error: ",e.message," -- while attempting to dump into file: ",u,"\n",e.stack)}c&&(c.offending_source_code=t,c.offending_source_title=n,c.offending_source_dumpfile=u)}var a={exec:function(e,r,t,n){t=t||{};var o,a,c=""+(n||"exec_test"),u=c.replace(/[^a-z0-9_]/ig,"_");0===u.length&&(u="exec_crash");try{if("function"!=typeof r)throw Error("safe-code-exec-and-diag: code_execution_rig MUST be a JavaScript function");o=e,(o=String(o)).match(/\bcov_\w+/)&&console.error("### ISTANBUL COVERAGE CODE DETECTED ###\n",o),a=r.call(this,e,t,c,0)}catch(r){if(t.dumpSourceCodeOnFailure&&i(e,c,u,t,r),t.throwErrorOnCompileFailure)throw r}return a},dump:i};let c=require("@gerhobbelt/recast");t(c);var u=c.types;function l(e){return c.parse(e)}t(u),t(u.namedTypes),t(u.builders);function s(e){var r,t=String(e);return(r=String(r=t)).match(/\bcov_\w+/)&&console.error("### ISTANBUL COVERAGE CODE DETECTED ###\n",r),t}let f=/^function[\s\r\n]*[^\(]*\(([^\)]*)\)[\s\r\n]*\{([^]*?)\}$/,d=/^(?:(?:\(([^\)]*)\))|(?:([^\(\)]+)))[\s\r\n]*=>[\s\r\n]*(?:(?:\{([^]*?)\})|(?:(([^\s\r\n\{)])[^]*?)))$/;var p={rmCommonWS:function(e,...r){var t=null,n=e.map(function(e){var r=e.split("\n");return t=r.reduce(function(e,r,t){if(0!==t){var n=/^(\s*)\S/.exec(r);n&&(e?n[1].length<e.length&&(e=n[1]):e=n[1])}return e},t),r}),o=n[n.length-1];if(o[o.length-1]=o[o.length-1].replace(/\s+$/,""),t)for(var i=0,a=n.length;i<a;i++)for(var c,u,o=n[i],l=1,s=o.length;l<s;l++)c=o[l],u=t,c.substr(0,u.length)===u&&(o[l]=o[l].substr(t.length));for(var f=[],i=0,a=r.length;i<a;i++)f.push(n[i].join("\n")),f.push(r[i]);return f.push(n[i].join("\n")),f.join("")},camelCase:n,mkIdentifier:function(e){return(e=n(""+e)).replace(/^[^\w_]/,"_").replace(/^\d/,"_").replace(/[^\w\d_]+/g,"_").replace(/^__+/,"#").replace(/__+$/,"#").replace(/_+/g,"_").replace(/#/g,"__")},dquote:function(e){var r=e.indexOf("'")>=0,t=e.indexOf('"')>=0;return r&&t&&(e=e.replace(/"/g,'\\"'),t=!1),e=t?"'"+e+"'":'"'+e+'"'},exec:a.exec,dump:a.dump,parseCodeChunkToAST:l,prettyPrintAST:function(e,r){var r=r||{};let t={tabWidth:2,quote:"single",arrowParensAlways:!0,reuseWhitespace:!1};for(var n in t)void 0===r[n]&&(r[n]=t[n]);return c.prettyPrint(e,{tabWidth:2,quote:"single",arrowParensAlways:!0,reuseWhitespace:!1}).code.replace(/\r\n|\n|\r/g,"\n")},checkActionBlock:function(e,r){if(r&&r.first_line>0&&(e=Array(r.first_line).join("\n")+e),!e.trim())return!1;try{return l(e),!1}catch(e){return e.message||"code snippet cannot be parsed"}},printFunctionSourceCode:s,printFunctionSourceCodeContainer:function(e){var r,t=s(e).trim(),n=f.exec(t);if(n)r=n[1].trim(),t=n[2].trim();else if(n=d.exec(t))r=n[2]?n[2].trim():n[1].trim(),t=n[5]?"return "+(t=n[4].trim())+";":n[3].trim();else{var o=Error("Cannot extract code from function");throw o.subject=t,o}return{args:r,code:t}},detectIstanbulGlobal:function(){return Function("return this")().__coverage__||!1}};export{p as default};
